<!-- Global Spinner -->
<ngx-spinner
  bdColor="rgba(0,0,0,0.5)"
  size="medium"
  color="#fff"
  type="ball-spin-clockwise"
  [fullScreen]="true"
  *ngIf="isLoggingOut"
></ngx-spinner>

<!-- Navbar -->
<div class="col-12 navbar-wrapper p-0 m-0">
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid px-3 px-lg-4">
      <!-- Brand -->
      <a class="navbar-brand fw-bold text-success" routerLink="/">
        <i class="bi bi-leaf me-2"></i>OrganicShop
      </a>

      <!-- Toggler -->
      <button
        class="navbar-toggler border-0"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Menu -->
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a
              class="nav-link"
              routerLink="/"
              routerLinkActive="active"
              [routerLinkActiveOptions]="{ exact: true }"
              (click)="closeMobileMenu()"
              >Home</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/about" (click)="closeMobileMenu()"
              >About</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/farms" (click)="closeMobileMenu()"
              >Farms</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              routerLink="/testimonials"
              (click)="closeMobileMenu()"
              >Testimonials</a
            >
          </li>
        </ul>

        <!-- Cart Button with Offcanvas -->
        <button
          class="btn btn-outline-success position-relative me-3"
          type="button"
          aria-label="View cart"
          (click)="openCartOffcanvas()"
        >
          <mat-icon style="font-size: 1.5rem; vertical-align: middle"
            >shopping_cart</mat-icon
          >
          <span
            *ngIf="cartItemCount > 0"
            class="badge bg-danger position-absolute top-0 start-100 translate-middle"
          >
            {{ cartItemCount }}
          </span>
        </button>

        <!-- User Dropdown -->
        <div class="nav-item dropdown">
          <button
            class="btn btn-sm {{
              getIconBgClass()
            }} rounded-circle d-flex align-items-center justify-content-center"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            aria-label="User menu"
            style="width: 40px; height: 40px"
          >
            <i class="bi bi-person" style="font-size: 1.5rem"></i>
          </button>
          <ul
            class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3"
          >
            <ng-container *ngIf="currentUser; else notAuthenticated">
              <li class="dropdown-item-text text-muted small">
                Welcome, {{ currentUser.fullName || currentUser.email }}
              </li>
              <li>
                <a
                  class="dropdown-item"
                  routerLink="/profile"
                  (click)="closeMobileMenu()"
                  >Profile</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  routerLink="/orders"
                  (click)="closeMobileMenu()"
                  >Orders</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button class="dropdown-item text-danger" (click)="logout()">
                  Logout
                </button>
              </li>
            </ng-container>
            <ng-template #notAuthenticated>
              <li>
                <a class="dropdown-item" routerLink="/auth/login">Login</a>
              </li>
              <li>
                <a class="dropdown-item" routerLink="/auth/register"
                  >Register</a
                >
              </li>
            </ng-template>
          </ul>
        </div>
      </div>
    </div>
  </nav>
</div>

<!-- Offcanvas Cart -->
<div
  class="offcanvas offcanvas-end p-0 m-0"
  tabindex="-1"
  id="cartOffcanvas"
  aria-labelledby="cartOffcanvasLabel"
  data-bs-backdrop="true"
>
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold text-success" id="cartOffcanvasLabel">
      <i class="bi bi-cart3 me-2"></i> Your Cart
    </h5>
  <button
      type="button"
      class="btn-close btn-close-dark"
      data-bs-dismiss="offcanvas"
      aria-label="Close"
    ></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">
    <!-- Loading -->
    <div *ngIf="loading" class="text-center mt-3">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- Not logged in -->
    <div
      *ngIf="!loading && !isLoggedIn"
      class="alert alert-warning text-center mt-3"
    >
      ðŸ”’ Please <a routerLink="/auth/login" class="fw-bold">log in</a> to view
      your cart.
    </div>

    <!-- Empty cart -->
    <div
      *ngIf="!loading && isLoggedIn && cartItems.length === 0"
      class="alert alert-info text-center mt-3"
    >
      ðŸ›’ Your cart is empty.
    </div>

    <!-- Cart items -->
    <div
      *ngIf="!loading && isLoggedIn && cartItems.length > 0"
      class="cart-scroll flex-grow-1"
    >
      <div
        *ngFor="let item of cartItems"
        class="d-flex align-items-center justify-content-between border-bottom py-2"
      >
        <div class="d-flex align-items-center w-100">
          <img
            [src]="
              item.imageUrl ||
              'https://rkmrajahmundry.org/wp-content/uploads/2020/04/default-placeholder.png'
            "
            class="rounded me-2"
            width="50"
            height="50"
            alt="{{ item.name }}"
          />
          <div class="d-flex flex-column flex-grow-1 w-100">
            <h6
              class="mb-1 d-flex justify-content-start flex-wrap flex-column"
            >
              <span class="text-truncate" style="max-width: 150px">{{
                item.name
              }}</span>
              <small class="text-muted"
                >â‚¹{{ item.discountPrice | number : "1.2-2" }} kg</small
              >
            </h6>
            <small class="text-muted">
              Total: â‚¹{{
                item.discountPrice * (item.quantityInCart || 1) | number : "1.2-2"
              }}
            </small>
          </div>
          <div
            class="w-50 d-flex align-items-center border justify-content-end gap-2"
          >
            <button
              mat-icon-button
              color="primary"
              (click)="decreaseQuantity(item)"
              aria-label="Decrease quantity"
            >
              <mat-icon>remove</mat-icon>
            </button>
            <span class="fw-semibold">{{ item.quantityInCart }}</span>
            <button
              mat-icon-button
              color="primary"
              (click)="increaseQuantity(item)"
              aria-label="Increase quantity"
            >
              <mat-icon>add</mat-icon>
            </button>
           
          </div>
           <button
              mat-icon-button
              class="text-danger"
              (click)="removeFromCart(item)"
              aria-label="Remove item"
            >
              <mat-icon>delete</mat-icon>
            </button>
        </div>
      </div>
    </div>

    <!-- Footer with Bill Summary -->
    <div
      *ngIf="!loading && isLoggedIn && cartItems.length > 0"
      class="offcanvas-footer border-top pt-3 mt-3 text-center"
    >
      <h6 class="fw-bold mb-3">Bill Summary</h6>
      <table class="table table-borderless table-sm">
        <thead>
          <tr>
            <th scope="col" class="text-start">Item</th>
            <th scope="col">Qty</th>
            <th scope="col" class="text-end">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cartItems">
            <td class="text-start text-truncate" style="max-width: 150px">
              {{ item.name }}
            </td>
            <td>{{ item.quantityInCart }}</td>
            <td class="text-end">
              â‚¹{{ item.discountPrice * (item.quantityInCart || 1) | number : "1.2-2" }}
            </td>
          </tr>
          <tr>
            <td class="fw-bold text-start">Total</td>
            <td></td>
            <td class="fw-bold text-end">
              â‚¹{{ totalPrice | number : "1.2-2" }}
            </td>
          </tr>
        </tbody>
      </table>
      <button
        mat-raised-button
        color="primary"
        class="w-100 mt-2"
        (click)="proceedToCheckout()"
      >
        Proceed to Checkout
      </button>
      <button
        mat-stroked-button
        color="warn"
        class="w-100 mt-2"
        (click)="clearCart()"
      >
        Clear Cart
      </button>
    </div>
  </div>
</div>
