<!-- âœ… Fullscreen Spinner -->
<ngx-spinner
  bdColor="rgba(0,0,0,0.5)"
  size="medium"
  color="#fff"
  type="ball-spin-clockwise"
  [fullScreen]="true"
  *ngIf="loading"
></ngx-spinner>

<!-- âœ… Payment Popup Overlay -->
<div class="payment-overlay d-flex align-items-center justify-content-center" *ngIf="showPaymentPopup">
  <div class="payment-popup card shadow-lg w-100" style="max-width: 450px;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">{{ selectedPaymentType === 'upi' ? 'UPI Payment' : 'Card Payment' }}</h5>
      <button class="btn btn-light btn-sm" (click)="closePaymentPopup()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="card-body">
      <!-- âœ… UPI QR Payment -->
      <div *ngIf="selectedPaymentType === 'upi'" class="text-center">
        <p class="fw-semibold">Scan QR Code to pay â‚¹{{ grandTotal | number: '1.2-2' }}</p>
        <div class="bg-white rounded p-3 d-inline-block">
          <img
            src="https://api.qrserver.com/v1/create-qr-code/?data=Harshal&size=220x220&margin=0"
            alt="UPI QR Code"
            class="img-fluid rounded"
          />
        </div>
        <p class="mt-3 mb-4">UPI ID: <span class="fw-bold text-primary">organic.shop "&#64;"paytm</span></p>
        <button mat-raised-button color="primary" (click)="processPayment()">
          Payment Completed
        </button>
      </div>

      <!-- âœ… Card Payment -->
      <div *ngIf="selectedPaymentType === 'card'">
        <form [formGroup]="cardForm">
          <mat-form-field class="w-100 mb-3">
            <mat-label>Card Number</mat-label>
            <input matInput formControlName="cardNumber" maxlength="16" placeholder="1234 5678 9012 3456" />
            <mat-error *ngIf="cardForm.get('cardNumber')?.hasError('pattern')">
              Enter valid 16-digit number
            </mat-error>
          </mat-form-field>

          <div class="row">
            <div class="col-md-6">
              <mat-form-field class="w-100 mb-3">
                <mat-label>Expiry (MM/YY)</mat-label>
                <input matInput formControlName="expiryDate" placeholder="MM/YY" maxlength="5" />
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field class="w-100 mb-3">
                <mat-label>CVV</mat-label>
                <input matInput formControlName="cvv" maxlength="4" type="password" />
              </mat-form-field>
            </div>
          </div>

          <mat-form-field class="w-100 mb-3">
            <mat-label>Card Holder Name</mat-label>
            <input matInput formControlName="cardHolderName" />
          </mat-form-field>

          <div class="text-center">
            <button mat-raised-button color="primary" [disabled]="cardForm.invalid" (click)="processPayment()">
              Pay â‚¹{{ grandTotal | number: '1.2-2' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Main Container -->
<div class="container-fluid py-4 px-md-5">
  <div class="text-center mb-4">
    <h1 class="fw-bold text-success">
      <i class="bi bi-receipt-cutoff me-2"></i>Generate Bill
    </h1>
    <p class="text-muted mb-0">Complete your order details and proceed to payment</p>
  </div>

  <!-- Not Logged In -->
  <div *ngIf="!isLoggedIn" class="alert alert-warning text-center">
    ðŸ”’ Please <a routerLink="/auth/login" class="fw-bold text-decoration-none">log in</a> to view your bill.
  </div>

  <!-- Empty Cart -->
  <div *ngIf="isLoggedIn && cartItems.length === 0" class="alert alert-info text-center">
    ðŸ›’ Your cart is empty. <a routerLink="/" class="fw-bold text-decoration-none">Continue shopping</a>.
  </div>

  <!-- âœ… Main Checkout Layout -->
  <div *ngIf="isLoggedIn && cartItems.length > 0" class="row g-4">
    <!-- ðŸ§¾ Customer Info -->
    <div class="col-lg-7">
      <mat-card class="shadow-lg">
        <mat-card-header class="bg-success text-white">
          <mat-card-title><i class="bi bi-person-check me-2"></i>Customer Details</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <form [formGroup]="addressForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>Full Name *</mat-label>
                  <input matInput formControlName="fullName" />
                </mat-form-field>
              </div>
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>Email *</mat-label>
                  <input matInput formControlName="email" type="email" />
                </mat-form-field>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>Mobile No. *</mat-label>
                  <input matInput formControlName="phone" placeholder="98XXXXXXXX" />
                </mat-form-field>
              </div>
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>Distance (km) *</mat-label>
                  <input matInput type="number" formControlName="distance" />
                  <small class="text-muted">â‰¤5km: â‚¹50 | â‰¤10km: â‚¹100 | >10km: â‚¹150</small>
                </mat-form-field>
              </div>
            </div>

            <mat-form-field class="w-100 mb-3">
              <mat-label>Address Line 1 *</mat-label>
              <input matInput formControlName="addressLine1" />
            </mat-form-field>

            <mat-form-field class="w-100 mb-3">
              <mat-label>Address Line 2</mat-label>
              <input matInput formControlName="addressLine2" />
            </mat-form-field>

            <mat-form-field class="w-100 mb-3">
              <mat-label>Landmark</mat-label>
              <input matInput formControlName="landmark" placeholder="Near XYZ Mall" />
            </mat-form-field>

            <div class="row">
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>City *</mat-label>
                  <input matInput formControlName="city" />
                </mat-form-field>
              </div>
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>State *</mat-label>
                  <input matInput formControlName="state" />
                </mat-form-field>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <mat-form-field class="w-100">
                  <mat-label>Zip Code *</mat-label>
                  <input matInput formControlName="zipCode" />
                </mat-form-field>
              </div>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- ðŸ’³ Bill Summary + Payment -->
    <div class="col-lg-5">
      <!-- âœ… Order Summary -->
      <mat-card class="shadow-lg mb-4">
        <mat-card-header class="bg-primary text-white">
          <mat-card-title><i class="bi bi-cart-check me-2"></i>Order Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-3">
          <div *ngFor="let item of cartItems" class="d-flex justify-content-between align-items-center border-bottom py-2 small">
            <span class="text-truncate" style="max-width: 150px;">{{ item.name }}</span>
            <div class="text-end">
              <div>Qty: {{ item.quantityInCart }}</div>
              <div class="fw-bold">
                â‚¹{{ (item.discountPrice || item.price) * item.quantityInCart | number: '1.2-2' }}
              </div>
            </div>
          </div>

          <hr />
          <div class="d-flex justify-content-between fw-semibold">
            <span>Subtotal:</span><span>â‚¹{{ totalPrice | number: '1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Delivery:</span><span>â‚¹{{ deliveryCharge | number: '1.2-2' }}</span>
          </div>
          <hr />
          <div class="d-flex justify-content-between fw-bold text-success fs-5">
            <span>Grand Total:</span><span>â‚¹{{ grandTotal | number: '1.2-2' }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- âœ… Payment Method -->
      <mat-card class="shadow-lg">
        <mat-card-header class="bg-warning">
          <mat-card-title><i class="bi bi-credit-card me-2"></i>Payment Method</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-3">
          <mat-radio-group [(ngModel)]="paymentMethod" class="w-100">
            <mat-radio-button value="cod" class="d-block p-2 border rounded mb-2">
              <i class="bi bi-cash-stack text-success me-2 fs-5"></i> Cash on Delivery
            </mat-radio-button>

           <mat-radio-button
  value="upi"
  class="d-block p-2 border rounded mb-2"
  (change)="openPaymentPopup('upi')"
>
  <i class="bi bi-upc-scan text-primary me-2 fs-5"></i> UPI Payment
</mat-radio-button>

<mat-radio-button
  value="card"
  class="d-block p-2 border rounded"
  (change)="openPaymentPopup('card')"
>
  <i class="bi bi-credit-card-fill text-info me-2 fs-5"></i> Card Payment
</mat-radio-button>

          </mat-radio-group>
        </mat-card-content>
        <mat-card-actions class="p-3 border-top">
          <button
            mat-raised-button
            color="success"
            class="w-100 btn-lg"
            (click)="paymentMethod === 'cod' ? placeOrder() : openPaymentPopup('cod')"
            [disabled]="addressForm.invalid"
          >
            <i class="bi bi-check-circle me-2"></i>
            {{ paymentMethod === 'cod' ? 'Place Order - COD' : 'Proceed to Payment' }}
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>

